# AI Chatbot è©³ç´°ä»•æ§˜æ›¸

## ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#1-ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#2-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [èªè¨¼ãƒ»APIã‚­ãƒ¼ç®¡ç†](#3-èªè¨¼apiã‚­ãƒ¼ç®¡ç†)
4. [ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½](#4-ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½)
5. [ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šæ©Ÿèƒ½ï¼ˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆï¼‰](#5-ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šæ©Ÿèƒ½ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ)
6. [ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»è§£ææ©Ÿèƒ½](#6-ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è§£ææ©Ÿèƒ½)
7. [éŸ³å£°å…¥åŠ›æ©Ÿèƒ½](#7-éŸ³å£°å…¥åŠ›æ©Ÿèƒ½)
8. [éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½ï¼ˆTTSï¼‰](#8-éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½tts)
9. [PDFãƒ»æ–‡æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½](#9-pdfæ–‡æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½)
10. [ä¼šè©±å±¥æ­´ç®¡ç†](#10-ä¼šè©±å±¥æ­´ç®¡ç†)
11. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#11-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
12. [UIã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³](#12-uiã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³)
13. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#13-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
14. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#14-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ç›®çš„
OpenAI GPT-4oã‚’ä½¿ç”¨ã—ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªAIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ†ã‚­ã‚¹ãƒˆã€ç”»åƒã€éŸ³å£°ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ã£ã¦AIã¨å¯¾è©±ã§ãã‚‹ã€‚

### 1.2 ä¸»è¦æ©Ÿèƒ½
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆ
- ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªAIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
- ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å…¥åŠ›ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã€ç”»åƒã€éŸ³å£°ã€PDFï¼‰
- éŸ³å£°èª­ã¿ä¸Šã’å‡ºåŠ›
- ä¼šè©±å±¥æ­´ã®æ°¸ç¶šåŒ–

### 1.3 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ |
|---------|------|
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | Next.js 15, React 19, TypeScript |
| ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° | Tailwind CSS |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | Next.js API Routes |
| AI API | OpenAI GPT-4o, GPT-4o Vision |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | PostgreSQL (Neon) |
| ORM | Prisma 6.x |
| PDFè§£æ | pdfjs-dist |
| éŸ³å£°èªè­˜ | Web Speech API |
| éŸ³å£°åˆæˆ | Web Speech Synthesis API |

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (Browser)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ChatInterfaceâ”‚  â”‚CharacterSettingsâ”‚  â”‚    MessageInput      â”‚  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚ (ç”»åƒ/éŸ³å£°/PDF)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                      â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                          â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              SessionStorage (APIã‚­ãƒ¼)                      â”‚  â”‚
â”‚  â”‚              LocalStorage (ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP (fetch)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Next.js API Routes                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  POST /api/chat          â†’ OpenAI API (ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°)          â”‚
â”‚  GET  /api/conversations â†’ Prisma (ä¼šè©±ä¸€è¦§)                    â”‚
â”‚  GET  /api/conversations/[id] â†’ Prisma (ä¼šè©±è©³ç´°)               â”‚
â”‚  DELETE /api/conversations/[id] â†’ Prisma (ä¼šè©±å‰Šé™¤)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      OpenAI API         â”‚     â”‚   PostgreSQL (Neon)     â”‚
â”‚  - GPT-4o               â”‚     â”‚   - conversations       â”‚
â”‚  - GPT-4o Vision        â”‚     â”‚   - messages            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›]
     â”‚
     â–¼
[MessageInput] â”€â”€â”€ ãƒ†ã‚­ã‚¹ãƒˆ/ç”»åƒ/éŸ³å£°/PDF ã‚’åé›†
     â”‚
     â–¼
[ChatInterface] â”€â”€â”€ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆæ§‹ç¯‰
     â”‚              - message: ãƒ†ã‚­ã‚¹ãƒˆ
     â”‚              - images: Base64ç”»åƒé…åˆ—
     â”‚              - systemPrompt: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
     â”‚
     â–¼ POST /api/chat (X-API-Key ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ã)
     â”‚
[API Route] â”€â”€â”€ ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼
     â”‚          - APIã‚­ãƒ¼ç¢ºèª
     â”‚          - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸/ç”»åƒã®å­˜åœ¨ç¢ºèª
     â”‚
     â”œâ”€â”€â–¶ [Prisma] ä¼šè©±ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜
     â”‚
     â–¼
[OpenAI API] â”€â”€â”€ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
     â”‚
     â–¼ Server-Sent Events
     â”‚
[ChatInterface] â”€â”€â”€ ãƒãƒ£ãƒ³ã‚¯å—ä¿¡ãƒ»è¡¨ç¤º
     â”‚
     â–¼
[MessageList] â”€â”€â”€ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
```

---

## 3. èªè¨¼ãƒ»APIã‚­ãƒ¼ç®¡ç†

### 3.1 è¨­è¨ˆæ–¹é‡
ã‚µãƒ¼ãƒãƒ¼å´ã§APIã‚­ãƒ¼ã‚’ä¿æŒã›ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®OpenAI APIã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹è¨­è¨ˆã€‚

### 3.2 ä¿å­˜å ´æ‰€
- **SessionStorage**: ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹ã¨è‡ªå‹•å‰Šé™¤
- ã‚¿ãƒ–é–“ã§å…±æœ‰ã•ã‚Œãªã„ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼‰

### 3.3 å®Ÿè£…è©³ç´°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/components/ApiKeyInput.tsx`

```typescript
// ä¿å­˜
const handleSave = () => {
  if (apiKey.trim()) {
    sessionStorage.setItem('openai_api_key', apiKey.trim());
    setIsSaved(true);
    onApiKeyChange(apiKey.trim());
  }
};

// èª­ã¿è¾¼ã¿ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒã‚¦ãƒ³ãƒˆæ™‚ï¼‰
useEffect(() => {
  const savedKey = sessionStorage.getItem('openai_api_key');
  if (savedKey) {
    setApiKey(savedKey);
    setIsSaved(true);
    onApiKeyChange(savedKey);
  }
}, [onApiKeyChange]);

// å‰Šé™¤
const handleClear = () => {
  sessionStorage.removeItem('openai_api_key');
  setApiKey('');
  setIsSaved(false);
  onApiKeyChange(null);
};
```

### 3.4 APIã¸ã®é€ä¿¡æ–¹æ³•

```typescript
// ChatInterface.tsx
const response = await fetch('/api/chat', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-API-Key': apiKey,  // ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã§APIã‚­ãƒ¼ã‚’é€ä¿¡
  },
  body: JSON.stringify({ ... }),
});
```

### 3.5 ã‚µãƒ¼ãƒãƒ¼å´ã§ã®å—ã‘å–ã‚Š

```typescript
// app/api/chat/route.ts
const apiKey = request.headers.get('X-API-Key');

if (!apiKey) {
  return NextResponse.json(
    { error: 'API key is required' },
    { status: 401 }
  );
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®APIã‚­ãƒ¼ã§OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
const openai = new OpenAI({ apiKey });
```

---

## 4. ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½

### 4.1 ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹

OpenAI APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã€Server-Sent Eventså½¢å¼ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/chat/route.ts`

```typescript
// OpenAIã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
const stream = await openai.chat.completions.create({
  model: MODEL_NAME,  // 'gpt-4o'
  messages: openaiMessages,
  stream: true,
  max_tokens: 4096,
});

// ReadableStreamã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡
const readableStream = new ReadableStream({
  async start(controller) {
    for await (const chunk of stream) {
      const content = chunk.choices[0]?.delta?.content;
      if (content) {
        assistantResponse += content;

        // JSONå½¢å¼ã§ãƒãƒ£ãƒ³ã‚¯ã‚’é€ä¿¡
        controller.enqueue(
          encoder.encode(
            JSON.stringify({
              type: 'chunk',
              content: content,
              conversationId: currentConversationId,
            }) + '\n'
          )
        );
      }
    }

    // å®Œäº†ã‚·ã‚°ãƒŠãƒ«
    controller.enqueue(
      encoder.encode(
        JSON.stringify({
          type: 'done',
          conversationId: currentConversationId,
        }) + '\n'
      )
    );

    controller.close();
  },
});
```

### 4.2 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å—ä¿¡å‡¦ç†

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/components/ChatInterface.tsx`

```typescript
const reader = response.body?.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;

  const chunk = decoder.decode(value);
  const lines = chunk.split('\n').filter((line) => line.trim());

  for (const line of lines) {
    const data = JSON.parse(line);

    if (data.type === 'chunk') {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’è¿½åŠ 
      assistantMessage.content += data.content;
      setMessages((prev) => {
        const newMessages = [...prev];
        newMessages[newMessages.length - 1] = { ...assistantMessage };
        return newMessages;
      });
    } else if (data.type === 'done') {
      // å®Œäº†å‡¦ç†
      loadConversations();
    } else if (data.type === 'error') {
      setError(data.error);
    }
  }
}
```

### 4.3 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```typescript
// OpenAIã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼
type MessageContent =
  | string
  | Array<
      | { type: 'text'; text: string }
      | { type: 'image_url'; image_url: { url: string } }
    >;

const openaiMessages: Array<{
  role: 'system' | 'user' | 'assistant';
  content: MessageContent;
}> = [];
```

---

## 5. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šæ©Ÿèƒ½ï¼ˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆï¼‰

### 5.1 æ¦‚è¦

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®åå‰ã€ã‚¢ãƒã‚¿ãƒ¼ã€æ€§æ ¼ã€è©±ã—æ–¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹æ©Ÿèƒ½ã€‚è¨­å®šã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦OpenAI APIã«é€ä¿¡ã•ã‚Œã‚‹ã€‚

### 5.2 ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/components/CharacterSettings.tsx`

```typescript
export interface CharacterConfig {
  name: string;        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
  avatar: string;      // ã‚¢ãƒã‚¿ãƒ¼çµµæ–‡å­—
  personality: string; // æ€§æ ¼
  speechStyle: string; // è©±ã—æ–¹
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
const DEFAULT_CHARACTER: CharacterConfig = {
  name: 'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
  avatar: 'ğŸ¤–',
  personality: 'è¦ªåˆ‡ã§æ˜ã‚‹ã„',
  speechStyle: 'ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªæ•¬èª',
};
```

### 5.3 é¸æŠå¯èƒ½ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³

```typescript
// ã‚¢ãƒã‚¿ãƒ¼é¸æŠè‚¢
const AVATAR_OPTIONS = [
  'ğŸ¤–', 'ğŸ±', 'ğŸ¶', 'ğŸ¦Š', 'ğŸ°', 'ğŸ¼',
  'ğŸ¦„', 'ğŸ‘»', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ€', 'ğŸŒ¸'
];

// æ€§æ ¼é¸æŠè‚¢
const PERSONALITY_OPTIONS = [
  { value: 'è¦ªåˆ‡ã§æ˜ã‚‹ã„', label: 'è¦ªåˆ‡ã§æ˜ã‚‹ã„' },
  { value: 'çŸ¥çš„ã§ã‚¯ãƒ¼ãƒ«', label: 'çŸ¥çš„ã§ã‚¯ãƒ¼ãƒ«' },
  { value: 'å…ƒæ°—ã„ã£ã±ã„', label: 'å…ƒæ°—ã„ã£ã±ã„' },
  { value: 'è½ã¡ç€ã„ã¦å„ªã—ã„', label: 'è½ã¡ç€ã„ã¦å„ªã—ã„' },
  { value: 'ãƒ„ãƒ³ãƒ‡ãƒ¬', label: 'ãƒ„ãƒ³ãƒ‡ãƒ¬' },
];

// è©±ã—æ–¹é¸æŠè‚¢
const SPEECH_STYLE_OPTIONS = [
  { value: 'ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªæ•¬èª', label: 'ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªæ•¬èªï¼ˆã€œã§ã™ã­ï¼ï¼‰' },
  { value: 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«', label: 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆã€œã ã‚ˆï¼ï¼‰' },
  { value: 'ä¸å¯§èª', label: 'ä¸å¯§èªï¼ˆã€œã§ã”ã–ã„ã¾ã™ï¼‰' },
  { value: 'é–¢è¥¿å¼', label: 'é–¢è¥¿å¼ï¼ˆã€œã‚„ã§ï¼ï¼‰' },
];
```

### 5.4 ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯

```typescript
// LocalStorageã«ä¿å­˜ï¼ˆæ°¸ç¶šåŒ–ï¼‰
const handleSave = () => {
  localStorage.setItem('character_config', JSON.stringify(config));
  onCharacterChange(config);
  setIsOpen(false);
};

// èª­ã¿è¾¼ã¿ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒã‚¦ãƒ³ãƒˆæ™‚ï¼‰
useEffect(() => {
  const saved = localStorage.getItem('character_config');
  if (saved) {
    const parsed = JSON.parse(saved);
    setConfig(parsed);
    onCharacterChange(parsed);
  } else {
    onCharacterChange(DEFAULT_CHARACTER);
  }
}, [onCharacterChange]);

// ãƒªã‚»ãƒƒãƒˆ
const handleReset = () => {
  setConfig(DEFAULT_CHARACTER);
  localStorage.removeItem('character_config');
  onCharacterChange(DEFAULT_CHARACTER);
};
```

### 5.5 ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¸ã®åæ˜ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/components/ChatInterface.tsx`

ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã¯ã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦çµ„ã¿è¾¼ã¾ã‚Œã‚‹ã€‚

```typescript
const response = await fetch('/api/chat', {
  method: 'POST',
  headers: { ... },
  body: JSON.stringify({
    conversationId: currentConversationId,
    message: messageWithDocs,
    images: images,
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‹•çš„ç”Ÿæˆ
    systemPrompt: character ? `ã‚ãªãŸã¯ã€Œ${character.name}ã€ã¨ã„ã†åå‰ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
æ€§æ ¼: ${character.personality}
è©±ã—æ–¹: ${character.speechStyle}
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”Ÿç”£æ€§å‘ä¸Šã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹è¦ªã—ã¿ã‚„ã™ã„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¨ã—ã¦æŒ¯ã‚‹èˆã£ã¦ãã ã•ã„ã€‚
çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ã£ã¦ã€æ¥½ã—ã„é›°å›²æ°—ã§ä¼šè©±ã—ã¦ãã ã•ã„ã€‚` : undefined,
  }),
});
```

### 5.6 ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‡¦ç†

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/chat/route.ts`

```typescript
const { conversationId, message, images, systemPrompt } = await request.json();

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã®å…ˆé ­ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
if (systemPrompt) {
  openaiMessages.push({
    role: 'system',
    content: systemPrompt,
  });
}

// ãã®å¾Œã«ä¼šè©±å±¥æ­´ã‚’è¿½åŠ 
historyMessages.forEach((msg) => {
  openaiMessages.push({
    role: msg.role as 'user' | 'assistant',
    content: msg.content,
  });
});
```

### 5.7 UIè¡¨ç¤º

ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã¯ãƒ˜ãƒƒãƒ€ãƒ¼å·¦å´ã«é…ç½®ã•ã‚Œã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®šãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

```typescript
<button
  onClick={() => setIsOpen(!isOpen)}
  className="flex items-center gap-2 px-3 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white"
>
  <span className="text-xl">{config.avatar}</span>
  <span className="font-medium">{config.name}</span>
</button>
```

---

## 6. ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»è§£ææ©Ÿèƒ½

### 6.1 æ¦‚è¦

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€GPT-4o Visionã§å†…å®¹ã‚’è§£æã™ã‚‹æ©Ÿèƒ½ã€‚

### 6.2 ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```typescript
export interface ImageAttachment {
  base64: string;  // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿
  type: string;    // MIMEã‚¿ã‚¤ãƒ— (e.g., 'image/jpeg')
  name: string;    // ãƒ•ã‚¡ã‚¤ãƒ«å
}
```

### 6.3 ç”»åƒé¸æŠãƒ»Base64å¤‰æ›

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/components/MessageInput.tsx`

```typescript
const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const files = e.target.files;
  if (!files) return;

  const newImages: ImageAttachment[] = [];

  for (const file of Array.from(files)) {
    if (file.type.startsWith('image/')) {
      const base64 = await fileToBase64(file);
      newImages.push({
        base64,
        type: file.type,
        name: file.name,
      });
    }
  }

  setImages((prev) => [...prev, ...newImages]);
};

// Fileã‚’Base64ã«å¤‰æ›
const fileToBase64 = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = reader.result as string;
      // data:image/jpeg;base64,xxxxx ã® xxxxx éƒ¨åˆ†ã‚’æŠ½å‡º
      const base64 = result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};
```

### 6.4 OpenAI Vision APIãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/chat/route.ts`

```typescript
if (hasImages) {
  const contentParts: Array<
    | { type: 'text'; text: string }
    | { type: 'image_url'; image_url: { url: string } }
  > = [];

  // ç”»åƒã‚’Vision APIå½¢å¼ã§è¿½åŠ 
  images.forEach((img: { base64: string; type: string }) => {
    contentParts.push({
      type: 'image_url',
      image_url: {
        url: `data:${img.type};base64,${img.base64}`,
      },
    });
  });

  // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
  if (hasMessage) {
    contentParts.push({
      type: 'text',
      text: message,
    });
  } else {
    // ç”»åƒã®ã¿ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    contentParts.push({
      type: 'text',
      text: 'ã“ã®ç”»åƒã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚',
    });
  }

  openaiMessages.push({
    role: 'user',
    content: contentParts,
  });
}
```

### 6.5 ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º

```typescript
{images.map((img, index) => (
  <div key={index} className="relative group">
    <img
      src={`data:${img.type};base64,${img.base64}`}
      alt={img.name}
      className="h-20 w-20 object-cover rounded-lg"
    />
    <button
      onClick={() => removeImage(index)}
      className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6"
    >
      Ã—
    </button>
  </div>
))}
```

---

## 7. éŸ³å£°å…¥åŠ›æ©Ÿèƒ½

### 7.1 æ¦‚è¦

Web Speech APIã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³å£°ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹æ©Ÿèƒ½ã€‚

### 7.2 ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª

```typescript
useEffect(() => {
  if (typeof window !== 'undefined') {
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    setSpeechSupported(!!SpeechRecognition);

    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.continuous = true;       // é€£ç¶šèªè­˜
      recognition.interimResults = true;   // ä¸­é–“çµæœã‚’å–å¾—
      recognition.lang = 'ja-JP';          // æ—¥æœ¬èª

      // ...ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š

      recognitionRef.current = recognition;
    }
  }
}, []);
```

### 7.3 éŸ³å£°èªè­˜ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†

```typescript
recognition.onresult = (event: SpeechRecognitionEvent) => {
  let transcript = '';
  for (let i = event.resultIndex; i < event.results.length; i++) {
    transcript += event.results[i][0].transcript;
  }

  setInput((prev) => {
    // æœ€çµ‚çµæœã®å ´åˆã®ã¿å…¥åŠ›ã«è¿½åŠ 
    if (event.results[event.results.length - 1].isFinal) {
      return prev + transcript;
    }
    return prev;
  });
};

recognition.onerror = () => {
  setIsListening(false);
};

recognition.onend = () => {
  setIsListening(false);
};
```

### 7.4 éŒ²éŸ³é–‹å§‹/åœæ­¢

```typescript
const toggleListening = () => {
  if (!recognitionRef.current) return;

  if (isListening) {
    recognitionRef.current.stop();
    setIsListening(false);
  } else {
    recognitionRef.current.start();
    setIsListening(true);
  }
};
```

### 7.5 UIè¡¨ç¤º

éŒ²éŸ³ä¸­ã¯ãƒœã‚¿ãƒ³ãŒèµ¤ããƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€‚

```typescript
<button
  onClick={toggleListening}
  disabled={disabled}
  className={`p-3 rounded-lg ${
    isListening
      ? 'text-red-500 bg-red-50 animate-pulse'
      : 'text-gray-500 hover:text-purple-600'
  }`}
  title={isListening ? 'éŒ²éŸ³åœæ­¢' : 'éŸ³å£°å…¥åŠ›'}
>
  {/* ãƒã‚¤ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ */}
</button>
```

---

## 8. éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½ï¼ˆTTSï¼‰

### 8.1 æ¦‚è¦

Web Speech Synthesis APIã‚’ä½¿ç”¨ã—ã¦ã€ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éŸ³å£°ã§èª­ã¿ä¸Šã’ã‚‹æ©Ÿèƒ½ã€‚

### 8.2 å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/components/MessageList.tsx`

```typescript
function SpeakButton({ text }: { text: string }) {
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [ttsSupported, setTtsSupported] = useState(false);

  useEffect(() => {
    setTtsSupported(
      typeof window !== 'undefined' && 'speechSynthesis' in window
    );
  }, []);

  const handleSpeak = () => {
    if (!ttsSupported) return;

    if (isSpeaking) {
      // åœæ­¢
      window.speechSynthesis.cancel();
      setIsSpeaking(false);
    } else {
      // å†ç”Ÿ
      window.speechSynthesis.cancel(); // æ—¢å­˜ã®èª­ã¿ä¸Šã’ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ja-JP';
      utterance.rate = 1.0;   // é€Ÿåº¦
      utterance.pitch = 1.0;  // ãƒ”ãƒƒãƒ

      utterance.onend = () => setIsSpeaking(false);
      utterance.onerror = () => setIsSpeaking(false);

      window.speechSynthesis.speak(utterance);
      setIsSpeaking(true);
    }
  };

  if (!ttsSupported) return null;

  return (
    <button onClick={handleSpeak} title={isSpeaking ? 'åœæ­¢' : 'èª­ã¿ä¸Šã’'}>
      {/* ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */}
    </button>
  );
}
```

### 8.3 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®çµ„ã¿è¾¼ã¿

```typescript
{message.role === 'assistant' && (
  <div>
    <MarkdownRenderer content={message.content} />
    <div className="flex justify-end mt-2">
      <SpeakButton text={message.content} />
    </div>
  </div>
)}
```

---

## 9. PDFãƒ»æ–‡æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

### 9.1 æ¦‚è¦

PDFã€ãƒ†ã‚­ã‚¹ãƒˆã€Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€å†…å®¹ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æŠ½å‡ºã—ã¦AIã«é€ä¿¡ã™ã‚‹æ©Ÿèƒ½ã€‚

### 9.2 ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```typescript
export interface DocumentAttachment {
  name: string;     // ãƒ•ã‚¡ã‚¤ãƒ«å
  content: string;  // æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆå†…å®¹
  type: string;     // MIMEã‚¿ã‚¤ãƒ—
}
```

### 9.3 ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/components/MessageInput.tsx`

```typescript
const handleDocSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const files = e.target.files;
  if (!files) return;

  setIsProcessingFile(true);

  for (const file of Array.from(files)) {
    try {
      let content = '';

      if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
        // PDFè§£æ
        const pdfjsLib = await import('pdfjs-dist/legacy/build/pdf.mjs');

        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({
          data: arrayBuffer,
          useWorkerFetch: false,
          isEvalSupported: false,
          useSystemFonts: true,
        });
        const pdf = await loadingTask.promise;
        const textParts: string[] = [];

        // å…¨ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items
            .map((item) => {
              if ('str' in item && typeof item.str === 'string') {
                return item.str;
              }
              return '';
            })
            .join(' ');
          textParts.push(pageText);
        }

        content = textParts.join('\n\n');

      } else if (
        file.type === 'text/plain' ||
        file.name.endsWith('.txt') ||
        file.name.endsWith('.md')
      ) {
        // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
        content = await file.text();
      }

      if (content.trim()) {
        setDocuments((prev) => [...prev, {
          name: file.name,
          content: content,
          type: file.type || 'text/plain',
        }]);
      }
    } catch (error) {
      console.error('Failed to process file:', file.name, error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã ã‘è¨˜éŒ²
      content = `[PDFãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} - ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ]`;
    }
  }

  setIsProcessingFile(false);
};
```

### 9.4 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®çµ„ã¿è¾¼ã¿

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/components/ChatInterface.tsx`

```typescript
// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿½åŠ 
let messageWithDocs = message;
if (documents && documents.length > 0) {
  const docContents = documents
    .map(d => `--- ${d.name} ---\n${d.content}`)
    .join('\n\n');

  messageWithDocs = message
    ? `${message}\n\nä»¥ä¸‹ã¯æ·»ä»˜ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã§ã™:\n\n${docContents}`
    : `ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„:\n\n${docContents}`;
}
```

---

## 10. ä¼šè©±å±¥æ­´ç®¡ç†

### 10.1 ä¼šè©±ä¸€è¦§å–å¾—

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/conversations/route.ts`

```typescript
export async function GET() {
  const conversations = await prisma.conversation.findMany({
    orderBy: { updatedAt: 'desc' },
    include: {
      _count: { select: { messages: true } },
    },
  });

  return NextResponse.json({
    conversations: conversations.map((conv) => ({
      id: conv.id,
      title: conv.title,
      createdAt: conv.createdAt,
      updatedAt: conv.updatedAt,
      messageCount: conv._count.messages,
    })),
  });
}
```

### 10.2 ä¼šè©±è©³ç´°å–å¾—

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/conversations/[id]/route.ts`

```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;

  const conversation = await prisma.conversation.findUnique({
    where: { id },
    include: {
      messages: { orderBy: { createdAt: 'asc' } },
    },
  });

  if (!conversation) {
    return NextResponse.json(
      { error: 'Conversation not found' },
      { status: 404 }
    );
  }

  return NextResponse.json({
    id: conversation.id,
    title: conversation.title,
    messages: conversation.messages,
  });
}
```

### 10.3 ä¼šè©±å‰Šé™¤

```typescript
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;

  await prisma.conversation.delete({
    where: { id },
  });

  return NextResponse.json({ success: true });
}
```

### 10.4 æ–°è¦ä¼šè©±ä½œæˆï¼ˆãƒãƒ£ãƒƒãƒˆé€ä¿¡æ™‚ï¼‰

```typescript
// app/api/chat/route.ts
if (!currentConversationId) {
  const title = hasMessage
    ? message.substring(0, 50) + (message.length > 50 ? '...' : '')
    : 'ç”»åƒä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸';

  const conversation = await prisma.conversation.create({
    data: { title },
  });
  currentConversationId = conversation.id;
}
```

---

## 11. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 11.1 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«**: `prisma/schema.prisma`

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Conversation {
  id        String    @id @default(uuid())
  title     String
  messages  Message[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(
    fields: [conversationId],
    references: [id],
    onDelete: Cascade
  )
  role           String       // 'user' or 'assistant'
  content        String       @db.Text
  createdAt      DateTime     @default(now())

  @@index([conversationId])
}
```

### 11.2 ERå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Conversation        â”‚       â”‚        Message          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: String (PK, UUID)   â”‚â”€â”€â”    â”‚ id: String (PK, UUID)   â”‚
â”‚ title: String           â”‚  â”‚    â”‚ conversationId: String (FK)â”‚
â”‚ createdAt: DateTime     â”‚  â””â”€â”€â”€<â”‚ role: String            â”‚
â”‚ updatedAt: DateTime     â”‚       â”‚ content: Text           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ createdAt: DateTime     â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é–¢ä¿‚: Conversation 1:N Message (Cascade Delete)
```

### 11.3 Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/lib/db.ts`

```typescript
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
};

function createPrismaClient() {
  return new PrismaClient();
}

function getPrisma(): PrismaClient {
  if (!globalForPrisma.prisma) {
    globalForPrisma.prisma = createPrismaClient();
  }
  return globalForPrisma.prisma;
}

// Lazy proxy - ãƒ“ãƒ«ãƒ‰æ™‚ã§ã¯ãªãå®Ÿè¡Œæ™‚ã«åˆæœŸåŒ–
export const prisma = new Proxy({} as PrismaClient, {
  get(_target, prop) {
    const client = getPrisma();
    const value = client[prop as keyof PrismaClient];
    if (typeof value === 'function') {
      return value.bind(client);
    }
    return value;
  },
});
```

---

## 12. UIã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

### 12.1 å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/globals.css`

```css
/* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒƒãƒ— */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼ˆå³ã‹ã‚‰ï¼‰ */
@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼ˆå·¦ã‹ã‚‰ï¼‰ */
@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* ãƒã‚¦ãƒ³ã‚¹ã‚¤ãƒ³ */
@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  100% {
    transform: scale(1);
  }
}

/* ãƒ•ãƒ­ãƒ¼ãƒˆï¼ˆæµ®éŠï¼‰ */
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

/* ã‚¦ã‚£ã‚°ãƒ«ï¼ˆæºã‚Œï¼‰ */
@keyframes wiggle {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(-5deg); }
  75% { transform: rotate(5deg); }
}
```

### 12.2 ä½¿ç”¨ç®‡æ‰€

| ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ | ä½¿ç”¨ç®‡æ‰€ |
|--------------|---------|
| `animate-slide-in-right` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| `animate-slide-in-left` | ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° |
| `animate-fade-in-up` | ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ |
| `animate-bounce-in` | è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã€æ©Ÿèƒ½ãƒãƒƒã‚¸ |
| `animate-float` | ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã®é¡”æ–‡å­— |
| `animate-wiggle` | ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã®æ‹¬å¼§ |
| `animate-pulse` | éŒ²éŸ³ä¸­ã®ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ |

---

## 13. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 13.1 APIå´ã‚¨ãƒ©ãƒ¼å‡¦ç†

```typescript
// app/api/chat/route.ts
try {
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
} catch (error: any) {
  console.error('Chat API error:', error);
  const message = error?.message || 'Unknown error';
  return NextResponse.json(
    { error: message },
    { status: 500 }
  );
}
```

### 13.2 ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ã®ã‚¨ãƒ©ãƒ¼

```typescript
// ReadableStreamå†…ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
catch (error: any) {
  console.error('Streaming error:', error);
  controller.enqueue(
    encoder.encode(
      JSON.stringify({
        type: 'error',
        error: error?.message || 'Unknown error occurred',
      }) + '\n'
    )
  );
  controller.close();
}
```

### 13.3 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

```typescript
// ChatInterface.tsx
{error && (
  <div className="bg-red-100 dark:bg-red-900 border border-red-400 text-red-700 px-4 py-3 text-center">
    {error}
  </div>
)}
```

---

## 14. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 14.1 å®Ÿè£…æ¸ˆã¿ã®å¯¾ç­–

| é …ç›® | å¯¾ç­– |
|------|------|
| APIã‚­ãƒ¼ç®¡ç† | SessionStorageã«ä¿å­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶é–‰é–ã§å‰Šé™¤ï¼‰ |
| APIã‚­ãƒ¼é€ä¿¡ | ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆX-API-Keyï¼‰ã§é€ä¿¡ |
| XSSå¯¾ç­– | Reactã®JSXè‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— |
| SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ | Prisma ORMã«ã‚ˆã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª |
| CSRF | SameSite Cookieãƒãƒªã‚·ãƒ¼ |

### 14.2 æ—¢çŸ¥ã®èª²é¡Œï¼ˆIssueèµ·ç¥¨æ¸ˆã¿ï¼‰

- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã®å¼·åŒ– (#3)
- Base64ç”»åƒã®ã‚µã‚¤ã‚ºãƒ»ã‚¿ã‚¤ãƒ—æ¤œè¨¼ (#4)
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æƒ…å ±éœ²å‡ºé˜²æ­¢
- Markdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã®URLæ¤œè¨¼

---

## æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|-----------|---------|
| 2025-01-13 | 1.0 | åˆç‰ˆä½œæˆ |
